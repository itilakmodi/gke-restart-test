name: GKE Deploy or Restart

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: k8s-finops
      SERVICE_ACCOUNT: github-deployer@k8s-finops.iam.gserviceaccount.com
      CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      CLUSTER_REGION: ${{ secrets.GKE_LOCATION }}
      NAMESPACE: default
      DEPLOYMENT_NAME: hello-nginx

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Authenticate to Google Cloud using Workload Identity Federation
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          workload_identity_provider: projects/167189844279/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider
          service_account: ${{ env.SERVICE_ACCOUNT }}

      # Step 3: Set up gcloud CLI
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Step 4: Get GKE credentials
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials $CLUSTER_NAME \
            --region $CLUSTER_REGION \
            --project $PROJECT_ID

      # Step 5: Restart Pods in GKE (hello-nginx in default namespace)
      - name: Restart Pods in GKE
        run: |
          kubectl rollout restart deployment $DEPLOYMENT_NAME -n $NAMESPACE
          kubectl rollout status deployment $DEPLOYMENT_NAME -n $NAMESPACE
